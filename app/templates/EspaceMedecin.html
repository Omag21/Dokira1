<!doctype html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <title>Dokira - Espace Médecin</title>

    <!-- Styles -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="/static/css/medecin.css" rel="stylesheet" />
    <link rel="stylesheet" href="/static/css/messagerie.css">
</head>

<body>
    <!-- Navbar -->
    <nav class="top-navbar">
        <button class="menu-toggle">
            <i class="fas fa-bars"></i>
        </button>

        <div class="navbar-search">
            <i class="fas fa-search"></i>
            <input type="text" placeholder="Rechercher un patient, un dossier..." />
        </div>

        <div class="navbar-actions">
            <select class="language-selector">
                <option value="fr">FR</option>
                <option value="en">EN</option>
            </select>

            <button class="notification-btn">
                <i class="fas fa-bell"></i>
                <span class="notification-badge">3</span>
            </button>

            <div class="profile-dropdown">
                <div class="profile-avatar-container" style="position: relative; display: inline-block;">
                    <img id="profileAvatar"
                        src="https://ui-avatars.com/api/?name={{ medecin.prenom|default('')|first }}+{{ medecin.nom|default('')|first }}&background=0D8ABC&color=fff&size=45"
                        alt="Avatar" class="profile-avatar" style="width: 45px; height: 45px; border-radius: 50%; object-fit: cover;">
                    <div class="avatar-status"></div>
                    <label for="profilePhotoInput" class="upload-overlay" style="position: absolute; bottom: 0; right: 0; background: #0d8abc; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 2px solid #fff;">
                        <i class="fas fa-camera" style="color: #fff; font-size: 14px;"></i>
                    </label>
                    <input type="file" id="profilePhotoInput" name="profilePhoto" accept="image/*" style="display: none;" onchange="previewProfilePhoto(event)">
                </div>
                <div class="profile-info">
                    <div class="profile-name" id="medecinName">Dr. {{ medecin.prenom }} {{ medecin.nom }}</div>
                    <div class="profile-role" id="medecinSpecialite">{{ medecin.specialite }}</div>
                </div>
        </div>
    </nav>

    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-brand">
            <div class="logo-text">
                <i class="fas fa-user-md"></i>
                Dokira Pro
            </div>
        </div>

        <ul class="sidebar-menu">
            <li class="menu-item">
                <a href="#" class="menu-link active" data-section="dashboard">
                    <i class="fas fa-th-large"></i>
                    <span>Tableau de Bord</span>
                </a>
            </li>
            <li class="menu-item">
                <a href="#" class="menu-link" data-section="patients">
                    <i class="fas fa-users"></i>
                    <span>Mes Patients</span>
                </a>
            </li>
            <li class="menu-item">
                <a href="#" class="menu-link" data-section="rdv">
                    <i class="fas fa-calendar-check"></i>
                    <span>Mes Rendez-vous</span>
                    <span class="menu-badge">8</span>
                </a>
            </li>
            <li class="menu-item">
                <a href="#" class="menu-link" data-section="dossiers">
                    <i class="fas fa-folder-medical"></i>
                    <span>Dossiers Médicaux</span>
                </a>
            </li>
            <li class="menu-item">
                <a href="#" class="menu-link" data-section="ordonnances">
                    <i class="fas fa-prescription-bottle"></i>
                    <span>Ordonnances</span>
                </a>
            </li>
            <li class="menu-item">
                <a href="#" class="menu-link" data-section="messagerie">
                    <i class="fas fa-comments"></i>
                    <span>Messagerie</span>
                    <span class="menu-badge">3</span>
                </a>
            </li>
            <li class="menu-item">
                <a href="#" class="menu-link" data-section="visio">
                    <i class="fas fa-video"></i>
                    <span>Visioconférences</span>
                </a>
            </li>
            <li class="menu-item">
                <a href="#" class="menu-link" data-section="historique">
                    <i class="fas fa-history"></i>
                    <span>Historique</span>
                </a>
            </li>
            <li class="menu-item">
                <a href="#" class="menu-link" data-section="profil">
                    <i class="fas fa-user-circle"></i>
                    <span>Mon Profil</span>
                </a>
            </li>
            <li class="menu-item">
                <a href="#" class="menu-link" data-section="parametres">
                    <i class="fas fa-cog"></i>
                    <span>Paramètres</span>
                </a>
            </li>
        </ul>

        <div style="padding: 20px 30px; margin-top: auto;">
            <a href="/medecin/deconnexionMedecin" class="menu-link" style="color: #fda4af;">
                <i class="fas fa-sign-out-alt"></i>
                <span>Déconnexion</span>
            </a>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <div id="mainContent">
            <!-- Le contenu sera injecté ici par medecin.js -->
        </div>
    </main>

    <!-- Modal Dossier Patient -->
    <div id="patientModal" class="modal fade" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Dossier Patient</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="patientModalBody">
                    <!-- Contenu du dossier patient -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Nouvelle Ordonnance -->
    <div id="ordonnanceModal" class="modal fade" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nouvelle Ordonnance</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="ordonnanceForm">
                        <input type="hidden" id="ordonnancePatientId">
                        
                        <div class="mb-3">
                            <label class="form-label">Patient</label>
                            <input type="text" class="form-control" id="ordonnancePatientName" readonly>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Médicament *</label>
                            <input type="text" class="form-control" id="ordonnanceMedicament" required placeholder="Nom du médicament">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Posologie *</label>
                            <textarea class="form-control" id="ordonnancePosologie" required placeholder="Ex: 1 comprimé matin et soir"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Durée du traitement</label>
                            <input type="text" class="form-control" id="ordonnanceDuree" placeholder="Ex: 7 jours">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Instructions particulières</label>
                            <textarea class="form-control" id="ordonnanceInstructions" placeholder="Observations..."></textarea>
                        </div>

                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            L'ordonnance sera convertie en PDF et envoyée au patient
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" id="submitOrdonnance">
                        <i class="fas fa-file-pdf"></i> Générer et Envoyer
                    </button>
                </div>
            </div>
        </div>
    </div>

    
    <div class="modal fade" id="ordonnanceModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, #0d8abc 0%, #00bcd4 100%); color: white;">
                    <h5 class="modal-title">
                        <i class="fas fa-prescription-bottle"></i> Nouvelle Ordonnance
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                
                <div class="modal-body">
                    <form id="ordonnanceForm">
                        <!-- Sélection du Patient -->
                        <div class="form-section">
                            <h6 class="section-header">
                                <i class="fas fa-user-circle"></i> Sélection du Patient
                            </h6>
                            
                            <div class="form-group mb-3">
                                <label class="form-label" for="ordonnancePatientSelect">
                                    <strong>Patient *</strong>
                                </label>
                                <select class="form-control form-select-lg" id="ordonnancePatientSelect" required>
                                    <option value="">-- Sélectionner un patient --</option>
                                </select>
                                <small class="form-text text-muted">Sélectionnez le patient pour qui vous créez cette ordonnance</small>
                            </div>
                            
                            <!-- Infos Patient affichées -->
                            <div id="patientInfoDisplay" style="display: none; background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #0d8abc;">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p><strong>Nom:</strong> <span id="displayPatientNom">-</span></p>
                                        <p><strong>Âge:</strong> <span id="displayPatientAge">-</span></p>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>Email:</strong> <span id="displayPatientEmail">-</span></p>
                                        <p><strong>Téléphone:</strong> <span id="displayPatientTel">-</span></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Prescription -->
                        <div class="form-section">
                            <h6 class="section-header">
                                <i class="fas fa-pills"></i> Prescription
                            </h6>
                            
                            <div class="form-group mb-4">
                                <label class="form-label" for="ordonnanceMedicaments">
                                    <strong>Médicament(s) *</strong>
                                </label>
                                <textarea 
                                    class="form-control" 
                                    id="ordonnanceMedicaments" 
                                    rows="4" 
                                    placeholder="Ex: Amoxicilline 500mg, Ibuprofène 400mg..."
                                    required
                                    style="resize: vertical; min-height: 80px;">
                                </textarea>
                                <small class="form-text text-muted">Listez tous les médicaments prescrits (nom et dosage)</small>
                            </div>
                            
                            <div class="form-group mb-4">
                                <label class="form-label" for="ordonnancePosologie">
                                    <strong>Posologie *</strong>
                                </label>
                                <textarea 
                                    class="form-control" 
                                    id="ordonnancePosologie" 
                                    rows="3" 
                                    placeholder="Ex: 2 comprimés 3 fois par jour pendant les repas..."
                                    required
                                    style="resize: vertical;">
                                </textarea>
                                <small class="form-text text-muted">Décrivez comment prendre les médicaments (dose, fréquence, moment)</small>
                            </div>
                            
                            <div class="form-group mb-3">
                                <label class="form-label" for="ordonnanceDuree">
                                    <strong>Durée du traitement *</strong>
                                </label>
                                <input 
                                    type="text" 
                                    class="form-control" 
                                    id="ordonnanceDuree" 
                                    placeholder="Ex: 7 jours, 2 semaines, 1 mois..."
                                    required>
                                <small class="form-text text-muted">Précisez la durée du traitement</small>
                            </div>
                        </div>
                        
                        <!-- Notes optionnelles -->
                        <div class="form-section">
                            <h6 class="section-header">
                                <i class="fas fa-notes-medical"></i> Notes (Optionnel)
                            </h6>
                            
                            <div class="form-group mb-3">
                                <label class="form-label" for="ordonnanceNotes">Notes complémentaires</label>
                                <textarea 
                                    class="form-control" 
                                    id="ordonnanceNotes" 
                                    rows="2" 
                                    placeholder="Contre-indications, recommandations, suivi médical..."
                                    style="resize: vertical;">
                                </textarea>
                            </div>
                        </div>
                        
                        <!-- Formulaire caché avec les données -->
                        <input type="hidden" id="ordonnancePatientId">
                        <input type="hidden" id="ordonnancePatientName">
                    </form>
                </div>
                
                <div class="modal-footer" style="border-top: 2px solid #f0f0f0;">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Annuler
                    </button>
                    <button type="button" class="btn btn-primary btn-lg" id="submitOrdonnanceBtn">
                        <i class="fas fa-check-circle"></i> Créer et Générer PDF
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- Script JS -->
    <script src="/static/js/medecin.js"></script>
    <script>
    // Prévisualisation et upload persistant de la photo de profil
    async function previewProfilePhoto(event) {
        const input = event.target;
        if (input.files && input.files[0]) {
            // Affichage immédiat (optionnel)
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('profileAvatar').src = e.target.result;
            };
            reader.readAsDataURL(input.files[0]);

            // Envoi au backend
            const formData = new FormData();
            formData.append('photo', input.files[0]);
            try {
                const response = await fetch('/medecin/api/upload-photo', {
                    method: 'POST',
                    body: formData
                });
                if (response.ok) {
                    const data = await response.json();
                    if (data.photo_url) {
                        document.getElementById('profileAvatar').src = data.photo_url;
                    }
                } else {
                    alert('Erreur lors de l\'upload de la photo');
                }
            } catch (err) {
                alert('Erreur réseau lors de l\'upload de la photo');
            }
        }
    }
    </script>
    <script src="/static/js/messagerie.js"></script> 
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>